description: 资产操作审批流程设计与约束（采购 → 入库试点，含与 DooTask 待办的集成约定）
globs: ["web/**"]
alwaysApply: false
---

## 1. 背景与范围

- 本规则文档用于约束 **资产操作审批流程** 的设计与落地实现，先以「采购 → 入库」作为首条试点主线，后续其它流程（领用、借用/归还、派发、维修、报废等）在此基础上演进。
- 目标：让 Asset Hub 从“记录工具”升级为可以驱动业务流程的系统，并与 DooTask 的 **待办/审批能力** 打通。
- 本文只定义：**状态机、数据模型、API 形态与宿主集成点**，具体实现细节在 `web/` 代码中展开。

约束前提：

- 所有 HTTP API 对外仍统一挂载在 `/apps/asset-hub/api/**` 前缀下。
- 审批相关能力优先围绕 **资产操作（operations）** 展开，而不是单独搞一套和资产完全脱钩的审批系统。

---

## 2. 核心实体与表结构（抽象层面）

### 2.1 已有相关实体（回顾）

- `assets`：资产主表（已存在），包含 `id/name/category/status/owner/location/purchaseDate/...`。
- `asset_operations`：资产操作记录表（已存在），用于记录与资产相关的业务动作（采购、入库、领用等），字段大致包括：
  - `id`：操作 ID。
  - `asset_id`：关联资产。
  - `type`：操作类型（如 `purchase` / `inbound` / `assign` / `borrow` / `return` / `dispose` 等）。
  - `status`：该操作本身的状态（如 `draft` / `pending` / `done` / `cancelled` 等）。
  - `note` / `meta`：备注与扩展字段（JSON）。
  - `created_at` / `updated_at` 等。

> 实际字段以 `lib/db/schema.ts` 中的 DDL 为准，本节只说明抽象关系。

### 2.2 新增：审批请求表 `asset_approval_requests`

为了承载“审批”语义，引入专门的审批请求实体，核心作用是：

- 把“**需要审批的业务操作**”抽象成统一的请求（Request）。
- 将审批状态与业务操作状态解耦，但通过外键进行绑定。

建议表结构（逻辑层面）：

- `id`：审批请求 ID。
- `asset_id`：可选，关联资产 ID（对「入库前采购」场景，可以为空或使用虚拟资产 ID，由后续实现确定）。
- `operation_id`：可选，关联具体的 `asset_operations.id`；对于以“操作”为中心的审批（推荐），应当必填。
- `type`：审批类型（例如：`purchase` / `inbound` / `borrow` / `return` / `dispose` / `generic` 等）。
- `status`：审批状态（见 §3）。
- `title`：审批标题（例如「【采购】MacBook Pro 14 審批」）。
- `reason` / `content`：申请事由或详细说明。
- `applicant_id`：发起人（来自 `/api/me` 或 DooTask 注入的用户上下文）。
- `approver_id`：当前主审批人（首期可以固定为某个角色/用户，后续支持多级/自定义规则）。
- `result`：审批结果简要描述（通过/驳回/撤销原因等）。
- `external_todo_id`：与 DooTask 待办/审批记录关联的外部 ID（字符串），便于后续更新/关闭。
- `created_at` / `updated_at` / `completed_at`：时间戳。

设计原则：

- **一条业务操作，对应 0..1 条审批请求**：
  - 对于必须审批的操作（如“采购申请”、“入库确认”），`operation_id` 必须指向相应的 `asset_operations` 记录。
  - 对于暂不需要独立操作记录的“配置型审批”（后期扩展），可以只用 `asset_approval_requests` 承载。
- 首期只实现 **单级审批**，后续可在不破坏兼容性的前提下扩展多级流程（例如引入 `asset_approval_steps`）。

---

## 3. 状态机设计

### 3.1 通用审批状态（`asset_approval_requests.status`）

统一使用以下状态枚举：

- `draft`：草稿，仅在客户端或后台临时保存（首期可以不持久化，直接从 `pending` 开始）。
- `pending`：待审批（已提交，等待审批人处理）。
- `approved`：已通过。
- `rejected`：已驳回。
- `cancelled`：已撤销（通常由申请人发起）。

状态迁移规则：

- （可选）`draft` → `pending`：发起人提交审批。
- `pending` → `approved`：审批人同意。
- `pending` → `rejected`：审批人驳回。
- `pending` → `cancelled`：申请人撤销。
- 终态：`approved` / `rejected` / `cancelled` 为终态，常规流程不再变更。

需要与业务操作状态联动的规则见下一节。

### 3.2 采购流程（Purchase）

目标：把「采购申请」从简单记录升级为需要审批的流程。

典型路径：

1. 用户在 Asset Hub 中发起“采购申请”（不一定已有资产记录）：
   - 表单内容包括：资产名称、类别、预计金额、数量、申请事由等。
   - 后端创建一条 `asset_operations` 记录（`type = "purchase"`，`status = "pending"`）。
   - 同时创建一条 `asset_approval_requests` 记录（`type = "purchase"`，`status = "pending"`），并记录关联的 `operation_id`。
2. 审批人处理：
   - 同意：`asset_approval_requests.status` → `approved`；`asset_operations.status` → `done`（或 `approved`，由实现统一）；可根据需要自动生成“待入库”的资产记录（如 `assets.status = "pending-inbound"`）。
   - 驳回：`status` → `rejected`，`asset_operations.status` → `cancelled` 或独立状态；记录 `result` 文本。
   - 撤销：申请人主动取消，`status` → `cancelled`，`asset_operations.status` → `cancelled`。

注意：

- 首期可以简化为：**采购审批通过后仅记录操作，不强制自动创建资产记录**，由管理员在入库时补充/创建真实资产，避免流程过早绑定具体资产信息。

### 3.3 入库流程（Inbound）

目标：对“入库确认”也支持审批（可作为可选配置）。

路径示例：

1. 对于已通过采购审批的资产，在实际到货时由管理员发起“入库确认”，创建：
   - 一条 `asset_operations`（`type = "inbound"`，`status = "pending"`）。
   - 如需要审批，则创建一条 `asset_approval_requests`（`type = "inbound"`，`status = "pending"`）。
2. 审批人（可能与采购审批人不同）进行确认：
   - 同意：`asset_approval_requests.status` → `approved`；`asset_operations.status` → `done`；同时更新 `assets.status` 为 `in-use` 或 `idle`，并补充入库信息（位置、照片等）。
   - 驳回/撤销：参照采购流程逻辑。

首期实现建议：

- 优先把“采购审批”打通；“入库审批”可以复用同一机制，但允许在系统配置中做“是否启用入库审批”的开关（后续实现）。

---

## 4. API 设计（对外形态）

所有路径对外前缀均为 `/apps/asset-hub/api`，下文省略此前缀。

### 4.1 审批请求基础 API

- `POST /api/approvals`
  - 用途：创建审批请求（例如采购申请，可以无需已有资产 ID）。
  - 请求体：包含 `type`、业务字段（如资产名称/类别/金额/数量）、`reason`、`applicant` 信息等；后端可同时创建对应的 `asset_operations`。
  - 响应：返回创建的审批请求以及（如有）关联的操作/资产 ID。

- `GET /api/approvals`
  - 用途：按条件查询审批列表。
  - 查询参数示例：
    - `type=purchase|inbound|...`
    - `status=pending|approved|rejected|cancelled`
    - `role=my-requests|my-tasks`（我发起的 / 待我审批的）。

- `GET /api/approvals/:id`
  - 用途：获取单条审批详情，包括关联的资产、操作、历史记录等。

- `POST /api/approvals/:id/actions`
  - 用途：对审批执行操作（同意/驳回/撤销）。
  - 请求体示例：
    - `{ "action": "approve", "comment": "同意采购" }`
    - `{ "action": "reject", "comment": "预算不足" }`
    - `{ "action": "cancel", "comment": "需求取消" }`
  - 后端职责：
    - 校验当前用户是否有权限执行该动作；
    - 更新 `asset_approval_requests.status`；
    - 根据审批结果联动更新 `asset_operations` / `assets`；
    - 调用 DooTask 宿主更新/关闭对应待办（如有）。

### 4.2 与资产详情/操作的衔接 API

- `POST /api/assets/:id/approval`
  - 用途：在已有资产基础上发起审批（例如“报废”、“借用”等），首期可用于演示入库后场景。
  - 行为：创建一个 `asset_operations`（如 `type = "dispose"`），再创建对应的 `asset_approval_requests`。

> 最终实现时，可根据开发体验对路径进行微调，但需保持“审批主资源是 `/api/approvals`，资产侧提供便捷入口”这一原则。

---

## 5. 前端交互与页面规划

### 5.1 资产详情页扩展

- 在现有 `app/assets/[id]/page.tsx` 中：
  - 增加“发起审批”入口（下拉菜单或按钮），支持选择操作类型（采购/入库/报废等）。
  - 在操作时间轴（timeline）中展示与审批相关的节点：
    - 显示审批状态、审批人、结果文案。
    - 点击可跳转到审批详情页 `/apps/asset-hub/approvals/:id`。

### 5.2 审批列表与详情页

- 新增页面路由规划（无 locale 段版，实际对外依旧 `/apps/asset-hub` 根前缀）：
  - `/apps/asset-hub/approvals`：审批中心列表。
    - Tab：`待我审批` / `我发起的` / `全部`。
    - 支持按 `type` / `status` / 时间范围过滤。
  - `/apps/asset-hub/approvals/:id`：审批详情页。
    - 展示基础信息、申请内容、关联资产/操作、审批历史。
    - 提供“同意/驳回/撤销”操作入口（基于当前用户权限）。

### 5.3 多语言与主题

- 复用现有 `AppShell`、`theme/lang` 查询参数机制：
  - 所有审批相关标题、状态标签、按钮文案同步提供中英文文案。
  - 保持 UI 风格与现有资产/系统页面一致（圆角卡片、按钮风格等）。

---

## 6. 与 DooTask 待办/审批的集成约定

### 6.1 集成方式总览

- 通过 `@dootask/tools` 能力与宿主 DooTask 交互：
  - 当前代码中已使用的能力：`isMicroApp` / `appReady` / `getThemeName` / `getUserInfo` 等。
  - 审批相关的“创建待办 / 更新待办”可能需要宿主侧提供额外 API 或工具函数，暂不在此文档中硬编码具体函数名。

设计约定：

- 在 `web/lib/integrations/dootask-approvals.ts` 中封装一层 **DooTask 审批/待办网关**，暴露类似接口：
  - `createApprovalTodo({ requestId, title, link, applicant, approver })`
  - `completeApprovalTodo({ requestId, result })`
- 服务器端 Route Handler 在处理 `/api/approvals` 创建/更新时，**只调用网关模块**，不直接依赖 `@dootask/tools` 的具体实现，便于在独立运行模式下回退为 no-op 或日志输出。

### 6.2 执行时机

- 创建审批请求时：
  - 若运行在 DooTask 宿主中（可通过配置或环境变量判断），调用 `createApprovalTodo`：
    - 标题包含审批类型与资产/申请名称；
    - 链接指向 Asset Hub 审批详情页，带上必要的 `theme/lang/user_id/user_token` 等参数。
    - 返回的外部待办 ID 写入 `asset_approval_requests.external_todo_id`。
- 审批状态变更时（approve/reject/cancel）：
  - 若存在 `external_todo_id`，调用 `completeApprovalTodo`：
    - 更新 DooTask 待办状态为完成/驳回/取消；
    - 保持宿主与插件状态一致。

### 6.3 独立运行模式（非 DooTask 宿主）

- 若 Asset Hub 独立运行（例如开发环境直接访问 `http://localhost:3000/apps/asset-hub`）：
  - `dootask-approvals` 网关应安全降级为 **纯本地逻辑**：
    - 不抛出错误，仅在 server log 中记录“模拟创建/更新待办”。
    - 审批流程在 Asset Hub 内部仍可完整执行。

---

## 7. 权限与角色（首期简化）

- 鉴于当前项目尚未实现完整的权限系统，审批模块首期策略：
  - “发起审批”：默认允许任何登录用户（或拥有基础资产操作权限的用户）发起。
  - “审批操作”：首期可以通过环境配置或简单规则限制为：
    - 资产管理员角色（`roles.scope = "asset"`）；
    - 或者指定的一些用户 ID。
- 后续若引入更完善的角色/权限模型，本规则作为默认策略，可在不破坏旧数据的前提下做增强。

---

## 8. 实施顺序建议（供实现时参考）

1. **数据库层**：在 `lib/db/schema.ts` 与 `scripts/migrate.ts` 中补充 `asset_approval_requests` 的表结构与迁移逻辑。
2. **仓储与服务层**：实现审批请求的 CRUD、状态迁移与与 `asset_operations` / `assets` 的联动逻辑。
3. **API 层**：实现 §4 定义的 Route Handlers（优先 `/api/approvals` 相关接口）。
4. **前端页面**：扩展资产详情页入口，新增审批列表/详情页面，并与 API 对接。
5. **宿主集成**：实现 `dootask-approvals` 网关，打通与 DooTask 待办的闭环；根据宿主实际 API 更新本规则文档中的相关约定。

以上规则在实现审批相关功能时应被视为“约束性设计”，如需调整，应先更新本文件再修改代码。

