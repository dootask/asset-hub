# 资产管理插件项目开发规划

## 一、项目概述
- **项目目标**：构建一套与 DooTask 深度集成的资产管理插件，为企业提供资产、耗材与后台配置的全流程管理能力。
- **使用场景**：适用于多公司或多项目团队的资产登记、审批、领用、借用及盘点场景，强调移动审批与任务协同。
- **核心价值**：提高资产透明度、规范审批流程、沉淀操作日志，并通过可视化大屏与突出展示信息增强管理决策。
- **鉴权与权限**：直接复用 `@dootask/tools` 自带的鉴权上下文，识别管理员/普通用户两种角色来控制插件功能，无需额外单点登录，仅维护角色映射表即可。

## 二、目录与技术栈说明
### 目录结构
- `dootask-plugin/`：遵循 DooTask 插件规范的集成层，负责与主系统通信、鉴权和入口注册。
- `ui/`：独立的前端工程，构建资产管理界面、仪表板、表单及图表页面。
- `server/`：Koa 服务端，提供资产业务 API、审批回调、报表导出等能力。
- 其他：`.github/workflows/release.yml`（自动发布）、`Dockerfile`（容器打包）。

### 技术栈
- **前端**：React + Vite + Tailwind CSS + shadcn/ui，使用 `@dootask/tools` 适配主应用，计划引入 Recharts/ECharts 处理图表。
- **后端**：Node.js + Koa + sqlite3；使用 `koa-router`、`koa-body`、`better-sqlite3` 或 `knex` 管理数据库；考虑引入 `zod` 校验。
- **插件层**：根据 DooTask 插件开发规范实现菜单注册、权限声明及消息推送。
- **服务部署**：Server 端以独立 Koa 微服务形式运行，通过 REST API 与插件交互，同时在 Docker 镜像中将插件、UI、API 一并打包并通过环境变量配置 DooTask 主体地址以兼顾嵌入式部署。

## 三、功能模块拆分
### 1. 首页
- 资产总览仪表板：展示资产总额、使用中、闲置、报废、待采购指标，可按公司或时间维度过滤。
- 资产分布统计：按类型/部门/成本中心出图表，支持折线、柱状、饼图切换。
- 快捷处理栏：审批中心、代办事项、帮助中心入口，与 DooTask 通知保持一致。
- 数据更新：指标由 server + sqlite 聚合，每 5 分钟自动刷新一次并支持手动刷新，无需实时流或外部数据仓库。

### 2. 系统管理
- 公司管理：管理多公司信息，支持层级/标签，控制资产可见范围。
- 人员管理：同步组织架构，允许导入、编辑、停用用户。
- 角色管理：内置超级管理员、资产类型管理员等；审批流程采用固定模板（提交→审核→通过），暂不支持条件化配置。
- 数据管理：操作日志、报表统计、自定义报表入口；支持导出与定时任务。
- 其他管理：操作管理、升级管理（版本+人数+套餐），可触发支付/续费流程。

### 3. 资产管理
- 资产设置：定义字段模板、状态、关联规则，支持多语言标签和校验。
- 资产列表：列表视图 + 详情抽屉 + 批量操作，按类型、状态、责任人筛选。
- 新增/导入/导出：单条表单或批量 Excel/CSV 导入，支持模板下载、导入校验、导出的字段选择。
- 分类管理：自定义资产类型、生命周期策略、折旧/提醒配置。
- 资产操作流程：采购、入库、领用、借用/归还、派发、维修、报废、回收、遗失等流程，统一提交流程（提交→审核→通过）并写入操作日志。
- 资产盘点：创建盘点任务、选择资产、分配责任人、生成盘点表并导出结果。
- 附件存储：资产照片及操作附件先写入本地文件系统，sqlite 仅记录文件路径/摘要，未来通过存储服务接口扩展至对象存储。

### 4. 耗材管理（扩展）
- 耗材设置：配置耗材类别、计量单位、安全库存阈值。
- 耗材流程：采购、入库、领用/出库、处理流程，复用审批中心。
- 出库管理：月底盘点 + 出库对账，导出报表。
- 耗材处理：针对过期/损坏/遗失的处理流程，记录责任人和费用。
- 耗材盘点：周期性盘点任务，形成盘点报告。
- 规划：耗材模块在迭代 3 启动，使用独立的数据表（如 `consumables`、`consumable_operations`）避免与资产表耦合，同时复用公共用户/审批能力。

### 5. 突出展示
- 在系统主界面或个人中心展示当前插件版本号、授权人数、到期时间。
- 可提供“查看版本说明/升级”按钮跳转升级管理。
- 当前版本展示仅需显示版本号与基本授权信息，暂不展示剩余授权或倒计时，可在后续商业化阶段再扩展。

## 四、数据与接口初步规划
- **核心数据表（建议 sqlite3 中规划）**
  - `companies`、`departments`、`users`、`roles`、`role_permissions`
  - `asset_categories`、`assets`、`asset_custom_fields`、`asset_operations`
  - `operation_attachments`（存储照片、附件元数据）、
  - `inventory_tasks`、`inventory_task_items`
  - `consumable_categories`、`consumables`、`consumable_operations`
  - `approvals`、`approval_logs`、`notifications`（用于记录固定流程的执行轨迹）
- **接口草案**
  - `/api/dashboard/metrics`：仪表板指标，支持公司/时间过滤。
  - `/api/system/companies|users|roles`：系统管理 CRUD。
  - `/api/system/approvals`：提交审批申请、查询审批结果；服务端按固定流程推进并写入日志。
  - `/api/assets`：列表、创建、更新、批量导入导出。
  - `/api/assets/{id}/operations`：采购/入库/领用/借用等操作记录。
  - `/api/assets/inventory`：新建盘点任务、提交结果、导出。
  - `/api/consumables` 与 `/api/consumables/operations`：耗材管理。
  - `/api/system/versions`：版本信息与升级计划。
- **集成点**
  - 与 DooTask 的 `@dootask/tools` 进行身份/租户同步、待办推送、审批流触发。
  - 需要 Webhook 或消息总线告知 DooTask 审批结果。
- 通讯录与审批复用：通过 `@dootask/tools` 自动同步当前登录用户信息，审批结果使用 `requestAPI` 调用 `dialog/msg/sendbot` 接口推送回主系统，无需重复实现通讯录或审批引擎。
- 批量导入模板：定义新的资产导入模板字段集合（编码、名称、类别、公司、负责人等），无需兼容历史资产数据，可提供脚本或文档指导用户按新模板整理。

## 五、迭代与里程碑规划
1. **迭代 0：环境搭建与 PoC（1 周）**
   - 初始化 dootask-plugin、ui、server 三端工程，完成 Hello World + 插件注册。
   - 设计 sqlite3 schema 雏形、配置 Docker 构建。
2. **迭代 1：核心资产管理 Beta（2-3 周，优先级 P0）**
   - 完成系统管理基础（公司、人、角色）、资产设置、资产列表 CRUD、采购/入库流程、仪表板基础指标。
   - 联通审批中心基础流程，接入 DooTask 待办。
3. **迭代 2：流程拓展与盘点（2 周，P1）**
   - 借用/归还、派发、维修、报废等流程，盘点任务、操作日志与报表导出。
   - 突出展示、升级管理。
4. **迭代 3：耗材管理与高级报表（2 周，P2）**
   - 耗材模块、出库盘点、可视化报表、可配置仪表板。
5. **迭代 4：优化与上线准备（1-2 周，P2）**
   - 性能优化、权限细粒度、插件发布流水线、文档编写。
- 外部里程碑：当前无展会或客户交付硬性日期，对齐团队内部节奏即可。

## 六、风险点与注意事项
- DooTask 插件规范变化或接口兼容性风险，需要持续跟踪官方文档。
- sqlite3 并发写入能力有限，若资产量较大需考虑读写分离或迁移到外部数据库。
- 审批流程复杂度高，可能需要可视化引擎或第三方 BPM 组件。
- 批量导入/导出依赖 Office/CSV 转换，需提供模板与错误回显。
- 多公司、多角色权限矩阵复杂，需要完善的权限校验中间件。
- 合规性：目前无额外合规或审计留存要求，日志保留策略与 sqlite 存储即可满足，后续若有监管需求再扩展。

## 七、待确认事项汇总
当前阶段所有关键问题均已明确，暂无额外待确认事项。如后续出现新需求或外部依赖，再补充记录。
